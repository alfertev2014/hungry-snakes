var F=Object.defineProperty;var E=(i,e,t)=>e in i?F(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var a=(i,e,t)=>(E(i,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();var h=(i=>(i[i.UP=0]="UP",i[i.RIGHT=1]="RIGHT",i[i.DOWN=2]="DOWN",i[i.LEFT=3]="LEFT",i))(h||{});const H=i=>{switch(i){case 0:return 2;case 1:return 3;case 2:return 0;case 3:return 1}},b=i=>{switch(i){case 1:return 1;case 3:return-1;default:return 0}},v=i=>{switch(i){case 0:return-1;case 2:return 1;default:return 0}};class X{constructor(e,t,n,s){a(this,"field");a(this,"_headX");a(this,"_headY");a(this,"_tailX");a(this,"_tailY");a(this,"_length");a(this,"_direction");a(this,"UP");a(this,"RIGHT");a(this,"DOWN");a(this,"LEFT");if(t<0||t>=e.width)throw new Error("Creating snake: headX is out of field dimention");if(n<0||n>=e.height)throw new Error("Creating snake: headY is out of field dimention");if(k(e.getCell(t,n)))throw new Error("Creating snake in place of already existing snake");this.field=e,this._headX=t,this._headY=n,this._tailX=t,this._tailY=n,this._length=1,this._direction=s,this.UP=new S(this,h.UP),this.RIGHT=new S(this,h.RIGHT),this.DOWN=new S(this,h.DOWN),this.LEFT=new S(this,h.LEFT),this._refreshHeadCell()}get length(){return this._length}get isDead(){return this._length<=0}get headX(){return this._headX}get headY(){return this._headY}get tailX(){return this._tailX}get tailY(){return this._tailY}get direction(){return this._direction}getSnakeCell(e){switch(e){case h.UP:return this.UP;case h.RIGHT:return this.RIGHT;case h.DOWN:return this.DOWN;case h.LEFT:return this.LEFT;default:throw new Error("Wrong direction!")}}_refreshHeadCell(){this.field.setCell(this._headX,this._headY,this.getSnakeCell(this._direction))}nextHeadCell(e){return this.field.getCell(this._headX+b(e),this._headY+v(e))}changeDirection(e){if(this.isDead)return!1;const t=this.nextHeadCell(e);return k(t)&&t.snake===this&&H(e)===t.direction?!1:(this._direction=e,this._refreshHeadCell(),!0)}doForcedStep(){this._doStep(!0)}doStep(){this._doStep()}_doStep(e=!1){if(this.isDead)return;const t=this.nextHeadCell(this._direction);switch(t){case f.EMPTY:this._doHeadStep(),this.doTailStep();break;case f.FOOD:this._doHeadStep();break;case f.BOUNDARY:case f.BRICK:e&&this.dropFood();break;case f.POISON:this._doHeadStep(),this.doTailStep(),this.doTailStep();break;default:{const n=t.snake,s=this._headX+b(this._direction),r=this._headY+v(this._direction),o=n.countToTail(s,r);n===this&&!e&&o>1||(this.length>=o?(n.cut(s,r),this._doHeadStep()):e&&this.dropFood())}}}_doHeadStep(){this.isDead||(this._headX+=b(this._direction),this._headY+=v(this._direction),this._refreshHeadCell(),this._length++)}doHeadStep(){const e=this.nextHeadCell(this._direction);if(k(e))throw new Error("Doing head step into snake cell");e!==f.BOUNDARY&&this._doHeadStep()}_doTailStep(e){if(this.isDead)return;const t=this.field.getCell(this._tailX,this._tailY);if(!k(t))throw Error("Tail step is not valid! Tail cell is not snake.");this.field.setCell(this._tailX,this._tailY,e),this._length--,this._length>0&&(this._tailX+=b(t.direction),this._tailY+=v(t.direction))}doTailStep(){this._doTailStep(f.EMPTY)}dropFood(){this._doTailStep(f.FOOD)}cut(e,t){const n=this.field.getCell(e,t);if(k(n)&&n.snake===this){for(;this._tailX!==e||this._tailY!==t;)this.dropFood();this.dropFood()}}countToTail(e,t){const n=this.field.getCell(e,t);if(k(n)&&n.snake===this){let s=1,r=this.tailX,o=this.tailY;for(;r!==e||o!==t;){const l=this.field.getCell(r,o);if(!k(l))throw Error("Tail counting is not valid! Cell is not snake.");r+=b(l.direction),o+=v(l.direction),s++}return s}return 0}}class S{constructor(e,t){a(this,"snake");a(this,"direction");this.snake=e,this.direction=t}}var f=(i=>(i[i.EMPTY=0]="EMPTY",i[i.FOOD=1]="FOOD",i[i.BRICK=2]="BRICK",i[i.POISON=3]="POISON",i[i.BOUNDARY=4]="BOUNDARY",i))(f||{});const k=i=>i instanceof S,B={background:"black",food:"gray",brick:"brown",poison:"purple"},U={color:"green",headColor:"magenta"};class W{constructor(e,t,n,s=B){a(this,"_canvas");a(this,"ctx");a(this,"theme");a(this,"gameWidth");a(this,"gameHeight");this._canvas=e,this.gameWidth=t,this.gameHeight=n,this.theme=s;const r=this._canvas.getContext("2d");if(r==null)throw new Error("Failed to get 2d context from canvas");this.ctx=r,this.ctx.fillStyle=this.theme.background}get width(){return this._canvas.width}get height(){return this._canvas.height}clearWithBackground(){this.ctx.fillStyle=this.theme.background,this.ctx.fillRect(0,0,this.width,this.height)}drawCellRect(e,t,n){const s=this.width/this.gameWidth,r=this.height/this.gameHeight,o=e*s,l=t*r;this.ctx.fillStyle=n,this.ctx.fillRect(o,l,s,r)}drawCell(e,t,n){if(n===f.EMPTY)return;let s=this.theme.background;switch(n){case f.FOOD:s=this.theme.food;break;case f.BRICK:s=this.theme.brick;break;case f.POISON:s=this.theme.poison;break}this.drawCellRect(e,t,s)}drawSnakeCell(e,t,n,s,r,o){const l=e??U,c=this.width/this.gameWidth,u=this.height/this.gameHeight,d=t*c,g=n*u,p=s===0?l.headColor:l.color;switch(this.ctx.fillStyle=p??l.color,r){case h.LEFT:this.ctx.beginPath(),this.ctx.moveTo(d,g+u/2),this.ctx.lineTo(d+c,g),this.ctx.lineTo(d+c,g+u),this.ctx.fill();break;case h.RIGHT:this.ctx.beginPath(),this.ctx.moveTo(d,g),this.ctx.lineTo(d+c,g+u/2),this.ctx.lineTo(d,g+u),this.ctx.fill();break;case h.UP:this.ctx.beginPath(),this.ctx.moveTo(d,g+u),this.ctx.lineTo(d+c/2,g),this.ctx.lineTo(d+c,g+u),this.ctx.fill();break;case h.DOWN:this.ctx.beginPath(),this.ctx.moveTo(d,g),this.ctx.lineTo(d+c,g),this.ctx.lineTo(d+c/2,g+u),this.ctx.fill();break;default:this.ctx.fillRect(d,g,c,u);break}}}const _=(i,e)=>Math.floor(Math.random()*(e-i)+i),y=(i,e,t,n)=>`hsla(${i} ${e}% ${t}% ${n??""})`,M={field:{width:120,height:90},cellGeneration:{foodCount:2e3,brickCount:50,poisonCount:50},botGeneration:{count:20}},I=()=>{switch(_(0,100)%4){case 0:return h.UP;case 1:return h.RIGHT;case 2:return h.DOWN;case 3:return h.LEFT;default:return h.UP}};class z{constructor(e){a(this,"snakeControl");this.snakeControl=e}doNextAction(){if(this.snakeControl.length===0)return;let t=_(0,100)>60?this.snakeControl.direction:I();const{headX:n,headY:s,tailX:r,tailY:o}=this.snakeControl;for(let l=0;l<3;++l){const c=n+b(t),u=s+v(t),d=this.snakeControl.getCell(c,u);if(this.snakeControl.isSelfSnake(d)){if(t===d.direction||c===r&&u===o)break;t=H(d.direction),l>0&&this.snakeControl.onArrowPressed(t)}else if(d===f.BOUNDARY||d===f.BRICK){t=I();break}else break}this.snakeControl.onArrowPressed(t)}}class K{constructor(e,t){a(this,"width");a(this,"height");a(this,"_cells");if(e<=0||t<=0)throw new Error("Dimensions of field must be grater than zero");this.width=e,this.height=t,this._cells=new Array(e*t);for(let n=0;n<this._cells.length;++n)this._cells[n]=f.EMPTY}getCell(e,t){return e<0||t<0||e>=this.width||t>=this.height?f.BOUNDARY:this._cells[e+t*this.width]}setCell(e,t,n){e<0||t<0||e>=this.width||t>=this.height||(this._cells[e+t*this.width]=n)}}class O{constructor(e,t=null){a(this,"_snake");a(this,"style");this._snake=e,this.style=t}get headX(){return this._snake.headX}get headY(){return this._snake.headY}get tailX(){return this._snake.tailX}get tailY(){return this._snake.tailY}get length(){return this._snake.length}get direction(){return this._snake.direction}getCell(e,t){return this._snake.field.getCell(e,t)}isSelfSnake(e){return k(e)&&this._snake===e.snake}onArrowPressed(e){const t=this.direction;this._snake.changeDirection(e),t===e&&this._snake.doForcedStep()}doPlayerStep(){var e;(e=this._snake)==null||e.doStep()}}class ${constructor(e){a(this,"_field");a(this,"_snakes");this._field=e,this._snakes=[]}get count(){return this._snakes.length}createSnake(e,t,n,s=null){const r=new X(this._field,e,t,n),o=new O(r,s);return this._snakes.push(o),o}contains(e){return e instanceof O&&this._snakes.includes(e)}killSnake(e){if(e instanceof O){const t=this._snakes.indexOf(e);t>=0&&this._snakes.splice(t,1)}}tick(){for(const e of this._snakes)e._snake.doStep()}drawAll(e){for(const t of this._snakes){const n=t._snake;if(n.length>0){let s=n.tailX,r=n.tailY,o=n.length-1,l;for(;o>=0;){const c=this._field.getCell(s,r);if(!k(c))throw new Error("Snake is corrupted!!!");switch(e.drawSnakeCell(t.style,s,r,o,c.direction,l),l=c.direction,o--,l){case h.UP:r--;break;case h.RIGHT:s++;break;case h.DOWN:r++;break;case h.LEFT:s--;break}}}}}}class q{constructor(e,t){a(this,"_field");a(this,"_snakesRegistry");a(this,"_playerSnake");a(this,"output");this._field=new K(e,t),this._snakesRegistry=new $(this._field),this._playerSnake=null,this.output=null}get width(){return this._field.width}get height(){return this._field.height}get snakesCount(){return this._snakesRegistry.count}get isPlayerAlive(){return this._playerSnake!==null}putCell(e,t,n){this._field.setCell(e,t,n)}getCell(e,t){return this._field.getCell(e,t)}createSnake(e,t,n,s=null){return this._snakesRegistry.createSnake(e,t,n,s)}createPlayerSnake(e,t,n,s=null){return this._playerSnake=this._snakesRegistry.createSnake(e,t,n,s),this._playerSnake}get playerSnake(){return this._playerSnake}tick(){this._snakesRegistry.tick()}draw(){if(this.output!==null){this.output.clearWithBackground();for(let e=0;e<this._field.height;++e)for(let t=0;t<this._field.width;++t){const n=this._field.getCell(t,e);k(n)||this.output.drawCell(t,e,n)}this._snakesRegistry.drawAll(this.output)}}}const V=()=>{const i=_(0,360),e=i+60;return{color:y(i,100,40),headColor:y(e,100,50)}};class j{constructor(e){a(this,"game");a(this,"bots");a(this,"config");a(this,"_intervalId",null);this.config=e;const{width:t,height:n}=this.config.field;this.game=new q(t,n),this.bots=[],this._intervalId=null}_initializeField(){const{width:e,height:t}=this.config.field,{foodCount:n=0,brickCount:s=0,poisonCount:r=0}=this.config.cellGeneration??{};for(let o=0;o<n;++o)this.game.putCell(_(0,e),_(0,t),f.FOOD);for(let o=0;o<s;++o)this.game.putCell(_(0,e),_(0,t),f.BRICK);for(let o=0;o<r;++o)this.game.putCell(_(0,e),_(0,t),f.POISON)}_initializePlayer(){const{width:e,height:t}=this.config.field,n=this.game.createPlayerSnake(Math.floor(e/2),Math.floor(t/2),h.UP),s=r=>{if(!(r.isComposing||r.keyCode===229)){switch(r.key){case"Down":case"ArrowDown":n.onArrowPressed(h.DOWN),n.doPlayerStep();break;case"Up":case"ArrowUp":n.onArrowPressed(h.UP),n.doPlayerStep();break;case"Left":case"ArrowLeft":n.onArrowPressed(h.LEFT),n.doPlayerStep();break;case"Right":case"ArrowRight":n.onArrowPressed(h.RIGHT),n.doPlayerStep();break}this.game.draw()}};window.addEventListener("keydown",s)}_initializeBots(){var s;const{width:e,height:t}=this.config.field,n=((s=this.config.botGeneration)==null?void 0:s.count)??0;for(let r=0;r<n;++r){const o=_(0,e),l=_(0,t);if(!k(this.game.getCell(o,l))){const c=this.game.createSnake(o,l,h.UP,V());this.bots.push(new z(c))}}}_startTimer(){this._intervalId=window.setInterval(()=>{for(const e of this.bots)e.doNextAction();this.game.tick(),this.game.draw()},400)}setGameOutput(e){this.game.output=e}redraw(){this.game.draw()}initialize(){this._initializeField(),this._initializePlayer(),this._initializeBots()}start(){this._startTimer()}stop(){this._intervalId!==null&&window.clearInterval(this._intervalId)}}const L=i=>{const e=document.getElementById(i);if(e==null)throw new Error(`Cannot find template id=${i}`);return e},w=(i,e)=>{const t=i.querySelector(e);if(t==null)throw new Error(`Cannot query selector by '${e}' of parent ${i.tagName}`);return t},J=(i,{gameWidth:e,gameHeight:t,onCanvasCreated:n,onCanvasResized:s})=>{const r=L("CanvasContainer");i.appendChild(r.content.cloneNode(!0));const o=w(i,"canvas"),l=w(i,".CanvasContainer");n(o);const c=e/t,u=new ResizeObserver(d=>{for(const g of d){const{width:p,height:C}=g.contentRect;if(p===0||C===0)return;p/C<c?(o.width=p,o.height=p/c):(o.width=C*c,o.height=C)}s()});return u.observe(l),()=>{u.disconnect()}},Q=(i,e,t)=>{var Y,A,G,D;const n=L("NewGameForm");i.appendChild(n.content.cloneNode(!0));const s={...e},r=w(i,'[name="width"]');r.valueAsNumber=s.field.width;function o(m){s.field.width=this.valueAsNumber}r.addEventListener("change",o);const l=w(i,'[name="height"]');l.valueAsNumber=s.field.height;function c(m){s.field.height=this.valueAsNumber}l.addEventListener("change",c);const u=w(i,'[name="foodCount"]');u.valueAsNumber=((Y=s.cellGeneration)==null?void 0:Y.foodCount)??0;function d(m){s.cellGeneration={...s.cellGeneration,foodCount:this.valueAsNumber}}u.addEventListener("change",d);const g=w(i,'[name="brickCount"]');g.valueAsNumber=((A=s.cellGeneration)==null?void 0:A.brickCount)??0;function p(m){s.cellGeneration={...s.cellGeneration,brickCount:this.valueAsNumber}}g.addEventListener("change",p);const C=w(i,'[name="poisonCount"]');C.valueAsNumber=((G=s.cellGeneration)==null?void 0:G.poisonCount)??0;function P(m){s.cellGeneration={...s.cellGeneration,poisonCount:this.valueAsNumber}}C.addEventListener("change",P);const T=w(i,'[name="botCount"]');T.valueAsNumber=((D=s.botGeneration)==null?void 0:D.count)??0;function N(m){s.botGeneration={...s.botGeneration,count:this.valueAsNumber}}T.addEventListener("change",N);const x=w(i,".form");function R(m){m.preventDefault(),this.checkValidity()&&t({...s})}return x.addEventListener("submit",R),()=>{r.removeEventListener("change",o),l.removeEventListener("change",c),u.removeEventListener("change",d),g.removeEventListener("change",p),C.removeEventListener("change",P),T.removeEventListener("change",N),x.removeEventListener("submit",R)}},Z={background:"black",food:y(0,0,30),brick:y(0,60,40),poison:y(300,100,10)},ee=i=>{let e,t,n=M;return e=Q(i,n,r=>{e(),i.replaceChildren();const{width:o,height:l}=r.field;e=J(i,{gameWidth:o,gameHeight:l,onCanvasCreated(c){const u=new W(c,o,l,Z);t=new j(r),t.setGameOutput(u),t.initialize(),t.start()},onCanvasResized(){t.redraw()}}),n=r}),()=>{t.stop(),e()}},te=document.getElementById("app");ee(te);
